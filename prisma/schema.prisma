generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model BundleTemplate {
  id          String               @id @default(cuid())
  name        String               @unique
  description String?
  baseItemId  String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  baseItem    Item                 @relation(fields: [baseItemId], references: [id], onDelete: Cascade)
  items       BundleTemplateItem[]

  @@index([baseItemId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model BundleTemplateItem {
  id                  String         @id @default(cuid())
  bundleTemplateId    String
  itemId              String
  quantityPerBaseUnit Int            @default(1)
  bundleTemplate      BundleTemplate @relation(fields: [bundleTemplateId], references: [id], onDelete: Cascade)
  item                Item           @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([bundleTemplateId, itemId])
  @@index([bundleTemplateId])
  @@index([itemId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Category {
  id            String        @id @default(cuid())
  name          String        @unique
  description   String?
  imageUrl      String?
  loadingOrder  Int           @default(999) // Truck loading sequence: Tents=1, Furniture=2, Sanitary=3, Electrical=4, Linen=5, Tools=6
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  items         Item[]
  subcategories Subcategory[]

  @@index([name])
  @@index([loadingOrder])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Challan {
  id                  String        @id @default(cuid())
  challanNumber       String        @unique
  projectId           String
  truckNumber         String?
  driverName          String?
  driverPhone         String?
  movementDirection   String?
  createdByUserId     String
  issueDate           DateTime      @default(now())
  expectedReturnDate  DateTime?
  remarks             String?
  createdAt           DateTime      @default(now())
  // Challan Automation fields
  status              ChallanStatus     @default(SENT)
  challanType         ChallanType       @default(DELIVERY)
  amount              Float?            // Total challan amount
  igstPercent         Float?            @default(18)
  cgstPercent         Float?            @default(9)
  sgstPercent         Float?            @default(9)
  // Transport details
  transporterName     String?
  lrBiltyNo           String?           // Lorry Receipt / Bilty Number
  contactPersonName   String?
  contactPersonNumber String?
  dispatchFrom        String?           // Material dispatch from address
  dispatchTo          String?           // Material dispatch to address
  // Transfer challan fields
  sourceSiteId        String?           // For transfer challans - source site
  createdBy           User          @relation(fields: [createdByUserId], references: [id])
  project             Project       @relation(fields: [projectId], references: [id])
  sourceSite          Site?         @relation("TransferChallans", fields: [sourceSiteId], references: [id])
  items               ChallanItem[]

  @@index([challanNumber])
  @@index([createdByUserId])
  @@index([issueDate])
  @@index([projectId])
  @@index([truckNumber])
  @@index([status])
  @@index([sourceSiteId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model ChallanItem {
  id               String                   @id @default(cuid())
  challanId        String
  itemId           String
  quantity         Int
  notes            String?
  // Return tracking fields
  returnedQuantity Int                      @default(0)
  returnStatus     ChallanItemReturnStatus? // Status of returned items
  returnNotes      String?
  challan          Challan @relation(fields: [challanId], references: [id], onDelete: Cascade)
  item             Item    @relation(fields: [itemId], references: [id])

  @@index([challanId])
  @@index([itemId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Item {
  id                  String               @id @default(cuid())
  categoryId          String
  subcategoryId       String?
  name                String
  description         String?
  quantityAvailable   Int                  @default(0)
  condition           ItemCondition        @default(GOOD)
  cost                Float?
  vendor              String?
  remarks             String?
  imageUrl1           String?
  imageUrl2           String?
  imageUrl3           String?
  currentLocation     String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  // Challan Automation fields
  weightPerUnit       Float?               // Weight in Kg (for truck capacity calculation)
  hsnCode             String?              // HSN/SAC code for GST
  // Tent Kit System fields
  isKitComponent      Boolean              @default(false) // Hide from main inventory if true
  kitType             String? // e.g., "FULL_FRAME_TENT"
  componentType       String? // e.g., "INNER", "CARPET", "PIPES"
  quantityPerKit      Int? // How many per tent (e.g., 4 for carpets)
  bundleTemplates     BundleTemplate[]
  bundleTemplateItems BundleTemplateItem[]
  challanItems        ChallanItem[]
  category            Category             @relation(fields: [categoryId], references: [id])
  subcategory         Subcategory?         @relation(fields: [subcategoryId], references: [id])
  maintenanceRecords  MaintenanceRecord[]
  purchaseOrderItems  PurchaseOrderItem[]
  repairQueue         RepairQueue[]
  scrapRecords        ScrapRecord[]
  siteInventory       SiteInventory[]
  stockMovements      StockMovement[]

  @@index([categoryId])
  @@index([condition])
  @@index([currentLocation])
  @@index([name])
  @@index([subcategoryId])
  @@index([isKitComponent])
  @@index([kitType])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model LabourAttendance {
  id             String    @id @default(cuid())
  labourName     String
  shiftType      ShiftType
  siteId         String?
  attendanceDate DateTime
  shiftsWorked   Float
  wagePerShift   Float?
  incentive      Float?    @default(0)
  totalWage      Float?
  notes          String?
  markedByUserId String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  markedBy       User      @relation(fields: [markedByUserId], references: [id])
  site           Site?     @relation(fields: [siteId], references: [id])

  @@index([attendanceDate])
  @@index([labourName])
  @@index([shiftType])
  @@index([siteId])
}

/// Labour master data - stores labour/employee information per site
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Labour {
  id               String              @id @default(cuid())
  name             String
  phone            String?
  address          String?
  defaultDailyRate Float               @default(500)
  siteId           String
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  
  // Relations
  site             Site                @relation(fields: [siteId], references: [id], onDelete: Cascade)
  attendanceRecords AttendanceRecord[]
  attendanceSheets  AttendanceSheet[]
  transactions      LabourTransaction[]
  
  @@unique([name, siteId]) // Prevent duplicate names per site
  @@index([siteId])
  @@index([name])
}

/// Daily attendance records - granular shift tracking per labour per day
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model AttendanceRecord {
  id                String           @id @default(cuid())
  labourId          String
  date              DateTime
  shifts            Float            @default(0) // 0, 0.5, 1, 1.5, 2, etc.
  siteId            String
  attendanceSheetId String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  labour            Labour           @relation(fields: [labourId], references: [id], onDelete: Cascade)
  site              Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  attendanceSheet   AttendanceSheet? @relation(fields: [attendanceSheetId], references: [id], onDelete: SetNull)
  
  @@unique([labourId, date]) // One record per labour per day
  @@index([labourId, date])
  @@index([siteId, date])
  @@index([attendanceSheetId])
}

/// Monthly attendance summary - aggregated data for payroll
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model AttendanceSheet {
  id              String              @id @default(cuid())
  labourId        String
  month           Int                 // 1-12
  year            Int                 // 2025, 2026, etc.
  siteId          String
  
  // Attendance data (JSON array of daily shifts)
  attendanceJson  Json                // [1, 1, 0.5, 2, 1, ...] (31 values)
  
  // Calculated fields
  totalShifts     Float               @default(0)
  dailyRate       Float
  wages           Float               @default(0) // totalShifts Ã— dailyRate
  incentive       Float               @default(0) // Manually entered
  netWages        Float               @default(0) // wages + incentive
  
  // Financial fields
  openingBalance  Float               @default(0) // Auto-fetched from previous month
  totalAdvance    Float               @default(0) // Sum of all advances
  totalPaid       Float               @default(0) // Sum of all payments
  netPayable      Float               @default(0) // netWages - totalAdvance + openingBalance
  balanceDue      Float               @default(0) // netPayable - totalPaid
  
  // Metadata
  status          String              @default("draft") // draft, finalized
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  finalizedAt     DateTime?
  
  // Relations
  labour          Labour              @relation(fields: [labourId], references: [id], onDelete: Cascade)
  site            Site                @relation(fields: [siteId], references: [id], onDelete: Cascade)
  attendanceRecords AttendanceRecord[]
  transactions    LabourTransaction[]
  
  @@unique([labourId, month, year, siteId])
  @@index([siteId, month, year])
  @@index([labourId])
  @@index([status])
}

/// Labour financial transactions - tracks advances and payments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model LabourTransaction {
  id                String          @id @default(cuid())
  labourId          String
  attendanceSheetId String
  type              String          // "advance" or "payment"
  amount            Float
  date              DateTime        @default(now())
  description       String?
  createdAt         DateTime        @default(now())
  
  // Relations
  labour            Labour          @relation(fields: [labourId], references: [id], onDelete: Cascade)
  attendanceSheet   AttendanceSheet @relation(fields: [attendanceSheetId], references: [id], onDelete: Cascade)
  
  @@index([labourId])
  @@index([attendanceSheetId])
  @@index([type])
  @@index([date])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model MaintenanceRecord {
  id               String            @id @default(cuid())
  itemId           String
  status           MaintenanceStatus @default(PENDING)
  notes            String?
  assignedToUserId String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  assignedTo       User?             @relation(fields: [assignedToUserId], references: [id])
  item             Item              @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([status])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Project {
  id             String          @id @default(cuid())
  name           String
  type           ProjectType     @default(OTHER)
  location       String
  siteId         String?
  startDate      DateTime
  endDate        DateTime?
  status         ProjectStatus   @default(PLANNED)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  challans       Challan[]
  site           Site?           @relation(fields: [siteId], references: [id])
  stockMovements StockMovement[]

  @@index([siteId])
  @@index([startDate])
  @@index([status])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model PurchaseOrder {
  id              String              @id @default(cuid())
  poNumber        String              @unique
  vendor          String
  orderDate       DateTime
  expectedDate    DateTime?
  status          POStatus            @default(PENDING)
  totalAmount     Float?
  pdfUrl          String?
  excelUrl        String?
  notes           String?
  createdByUserId String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  createdBy       User                @relation(fields: [createdByUserId], references: [id])
  items           PurchaseOrderItem[]
  stockMovements  StockMovement[]

  @@index([poNumber])
  @@index([status])
  @@index([vendor])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model PurchaseOrderItem {
  id               String        @id @default(cuid())
  purchaseOrderId  String
  itemId           String
  orderedQuantity  Int
  receivedQuantity Int           @default(0)
  unitCost         Float?
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  item             Item          @relation(fields: [itemId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([purchaseOrderId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model RepairQueue {
  id               String       @id @default(cuid())
  itemId           String
  status           RepairStatus @default(PENDING)
  assignedToUserId String?
  technicianName   String?
  vendorName       String?
  repairCost       Float?
  estimatedDays    Int?
  notes            String?
  startDate        DateTime?
  completedDate    DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  assignedTo       User?        @relation(fields: [assignedToUserId], references: [id])
  item             Item         @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([assignedToUserId])
  @@index([itemId])
  @@index([status])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model ScrapRecord {
  id             String          @id @default(cuid())
  itemId         String
  reason         String
  disposalMethod DisposalMethod?
  disposalDate   DateTime
  valueRealized  Float?
  disposalNotes  String?
  approvedBy     String?
  createdAt      DateTime        @default(now())
  item           Item            @relation(fields: [itemId], references: [id])

  @@index([disposalDate])
  @@index([itemId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Site {
  id                String             @id @default(cuid())
  name              String             @unique
  location          String
  description       String?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  labourAttendances LabourAttendance[]
  labours           Labour[]           // New labour management system
  attendanceRecords AttendanceRecord[] // Daily shift records
  attendanceSheets  AttendanceSheet[]  // Monthly summary sheets
  projects          Project[]
  siteInventory     SiteInventory[]
  transferChallans  Challan[]          @relation("TransferChallans") // Challans transferred from this site

  @@index([name])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model SiteInventory {
  id                 String    @id @default(cuid())
  siteId             String
  shiftType          ShiftType
  itemId             String
  quantityDeployed   Int
  deployedDate       DateTime  @default(now())
  expectedReturnDate DateTime?
  actualReturnDate   DateTime?
  notes              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  item               Item      @relation(fields: [itemId], references: [id])
  site               Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, itemId])
  @@index([itemId])
  @@index([siteId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model StockMovement {
  id                String         @id @default(cuid())
  itemId            String
  projectId         String?
  purchaseOrderId   String?
  movementType      MovementType
  quantity          Int
  previousQuantity  Int
  newQuantity       Int
  conditionAfter    String?
  notes             String?
  performedByUserId String
  createdAt         DateTime       @default(now())
  item              Item           @relation(fields: [itemId], references: [id])
  performedBy       User           @relation(fields: [performedByUserId], references: [id])
  project           Project?       @relation(fields: [projectId], references: [id])
  purchaseOrder     PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  @@index([createdAt])
  @@index([itemId])
  @@index([movementType])
  @@index([performedByUserId])
  @@index([projectId])
  @@index([purchaseOrderId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Subcategory {
  id          String   @id @default(cuid())
  categoryId  String
  name        String
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  items       Item[]
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, name])
  @@index([categoryId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model User {
  id                 String              @id @default(cuid())
  name               String
  email              String              @unique
  passwordHash       String
  role               UserRole            @default(VIEWER)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  challans           Challan[]
  labourAttendances  LabourAttendance[]
  maintenanceRecords MaintenanceRecord[]
  purchaseOrders     PurchaseOrder[]
  repairQueue        RepairQueue[]
  stockMovements     StockMovement[]

  @@index([email])
  @@index([role])
}

enum DisposalMethod {
  SALE
  DESTRUCTION
  DONATION
  RECYCLING
}

enum ItemCondition {
  GOOD
  REPAIR_NEEDED
  DAMAGED
  REPLACED
  SCRAP
}

enum MaintenanceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum MovementType {
  INWARD
  OUTWARD
  RETURN
  PURCHASE
  SALE
}

enum POStatus {
  PENDING
  PARTIALLY_RECEIVED
  FULLY_RECEIVED
  CANCELLED
}

enum ProjectStatus {
  PLANNED
  ACTIVE
  COMPLETED
}

enum ProjectType {
  CAMP
  FESTIVAL
  CORPORATE_EVENT
  RETREAT
  RENTAL
  OTHER
}

enum RepairStatus {
  PENDING
  IN_REPAIR
  COMPLETED
  SCRAPPED
}

enum ShiftType {
  WAREHOUSE
  SITE
}

enum UserRole {
  ADMIN
  INVENTORY_MANAGER
  VIEWER
}

// Challan Automation Enums
enum ChallanStatus {
  DRAFT
  SENT
  RETURNED
  PARTIALLY_RETURNED
  CANCELLED
}


enum ChallanType {
  DELIVERY
  RETURN
  TRANSFER
}

enum ChallanItemReturnStatus {
  RETURNED      // Item returned to stock
  REPAIR        // Item sent for repair
  SCRAP         // Item marked as scrap
  TRANSFERRED   // Item transferred to another site/project
}

/// Model to store company settings for challans and invoices
model CompanySettings {
  id               String   @id @default("default")
  companyName      String   @default("YOUR COMPANY NAME")
  tagline          String?  @default("Event Management & Tent Rental Services")
  registeredOffice String?
  corporateOffice  String?
  godownAddress    String?
  gstin            String?
  pan              String?
  email            String?
  phone            String?
  logoUrl          String?
  sellerState      String?  @default("DELHI")
  sellerStateCode  String?  @default("07")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}
